<!DOCTYPE html>
<!--
==============================================================================
           "GitHub HTML5 Pandoc Template" v2.2 — by Tristano Ajmone
==============================================================================
Copyright © Tristano Ajmone, 2017-2020, MIT License (MIT). Project's home:
- https://github.com/tajmone/pandoc-goodies
The CSS in this template reuses source code taken from the following projects:
- GitHub Markdown CSS: Copyright © Sindre Sorhus, MIT License (MIT):
  https://github.com/sindresorhus/github-markdown-css
- Primer CSS: Copyright © 2016-2017 GitHub Inc., MIT License (MIT):
  http://primercss.io/
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The MIT License
Copyright (c) Tristano Ajmone, 2017-2020 (github.com/tajmone/pandoc-goodies)
Copyright (c) Sindre Sorhus <sindresorhus@gmail.com> (sindresorhus.com)
Copyright (c) 2017 GitHub Inc.
"GitHub Pandoc HTML5 Template" is Copyright (c) Tristano Ajmone, 2017-2020,
released under the MIT License (MIT); it contains readaptations of substantial
portions of the following third party softwares:
(1) "GitHub Markdown CSS", Copyright (c) Sindre Sorhus, MIT License (MIT).
(2) "Primer CSS", Copyright (c) 2016 GitHub Inc., MIT License (MIT).
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
==============================================================================-->
<html>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>rCore-Tutorial-Book-v3学习笔记（二）</title>
  <style type="text/css">
@charset "UTF-8";.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";font-size:16px;line-height:1.5;word-wrap:break-word;box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto;padding:45px}.markdown-body a{color:#0366d6;background-color:transparent;text-decoration:none;-webkit-text-decoration-skip:objects}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body a:hover{text-decoration:underline}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body strong{font-weight:600}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em;margin:.67em 0;padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{padding-bottom:.3em;font-size:1.5em;border-bottom:1px solid #eaecef}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body img{border-style:none}.markdown-body svg:not(:root){overflow:hidden}.markdown-body hr{box-sizing:content-box;height:.25em;margin:24px 0;padding:0;overflow:hidden;background-color:#e1e4e8;border:0}.markdown-body hr::before{display:table;content:""}.markdown-body hr::after{display:table;clear:both;content:""}.markdown-body input{margin:0;overflow:visible;font:inherit;font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body li>p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dd{margin-left:0}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body code{font-family:SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace}.markdown-body pre{font:12px SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace;word-wrap:normal}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body table{display:block;width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body code{padding:.2em 0;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code::after,.markdown-body code::before{letter-spacing:-.2em;content:" "}.markdown-body pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:0 0;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}.markdown-body pre code::after,.markdown-body pre code::before{content:normal}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body kbd{box-shadow:inset 0 -1px 0 #959da5;display:inline-block;padding:3px 5px;font:11px/10px SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace;color:#444d56;vertical-align:middle;background-color:#fcfcfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}.markdown-body::before{display:table;content:""}.markdown-body::after{display:table;clear:both;content:""}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.Alert,.Error,.Note,.Success,.Warning{padding:11px;margin-bottom:24px;border-style:solid;border-width:1px;border-radius:4px}.Alert p,.Error p,.Note p,.Success p,.Warning p{margin-top:0}.Alert p:last-child,.Error p:last-child,.Note p:last-child,.Success p:last-child,.Warning p:last-child{margin-bottom:0}.Alert{color:#246;background-color:#e2eef9;border-color:#bac6d3}.Warning{color:#4c4a42;background-color:#fff9ea;border-color:#dfd8c2}.Error{color:#911;background-color:#fcdede;border-color:#d2b2b2}.Success{color:#22662c;background-color:#e2f9e5;border-color:#bad3be}.Note{color:#2f363d;background-color:#f6f8fa;border-color:#d5d8da}.Alert h1,.Alert h2,.Alert h3,.Alert h4,.Alert h5,.Alert h6{color:#246;margin-bottom:0}.Warning h1,.Warning h2,.Warning h3,.Warning h4,.Warning h5,.Warning h6{color:#4c4a42;margin-bottom:0}.Error h1,.Error h2,.Error h3,.Error h4,.Error h5,.Error h6{color:#911;margin-bottom:0}.Success h1,.Success h2,.Success h3,.Success h4,.Success h5,.Success h6{color:#22662c;margin-bottom:0}.Note h1,.Note h2,.Note h3,.Note h4,.Note h5,.Note h6{color:#2f363d;margin-bottom:0}.Alert h1:first-child,.Alert h2:first-child,.Alert h3:first-child,.Alert h4:first-child,.Alert h5:first-child,.Alert h6:first-child,.Error h1:first-child,.Error h2:first-child,.Error h3:first-child,.Error h4:first-child,.Error h5:first-child,.Error h6:first-child,.Note h1:first-child,.Note h2:first-child,.Note h3:first-child,.Note h4:first-child,.Note h5:first-child,.Note h6:first-child,.Success h1:first-child,.Success h2:first-child,.Success h3:first-child,.Success h4:first-child,.Success h5:first-child,.Success h6:first-child,.Warning h1:first-child,.Warning h2:first-child,.Warning h3:first-child,.Warning h4:first-child,.Warning h5:first-child,.Warning h6:first-child{margin-top:0}h1.title,p.subtitle{text-align:center}h1.title.followed-by-subtitle{margin-bottom:0}p.subtitle{font-size:1.5em;font-weight:600;line-height:1.25;margin-top:0;margin-bottom:16px;padding-bottom:.3em}div.line-block{white-space:pre-line}
  </style>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
<link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/css/bootstrap.min.css">
<script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/popper.js/1.12.9/popper.min.js" ></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/js/bootstrap.min.js" ></script>
<link rel="icon" href="/img/favicon.ico" type="image/x-icon" />
<link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top">
    <div class="container">
        <a class="navbar-brand" href="#">ZimingYuan的博客</a>
        <div class="navbar-collapse">
            <ul class="navbar-nav">
                <li class="nav-item active">
                    <a class="nav-link" href="/index.html">首页</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="/html/随笔.html">随笔</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="/html/CSP模板.html">CSP模板</a>
                </li>
            </ul>
        </div>
    </div>
</nav>
<article class="markdown-body">
<header>
<h1 class="title">rCore-Tutorial-Book-v3学习笔记（二）</h1>
</header>
<h3 id="概述">概述</h3>
<p>第二部分是实现一个批处理系统。批处理系统顾名思义就是能输入好几个程序，然后对这些程序<strong>依次</strong>执行的操作系统。重点不是在批处理，而是在输入用户程序，这就要求用户程序和我们的系统有一种隔离，所以需要在这一部分的系统实现用户态和内核态的切换。</p>
<h3 id="内容">内容</h3>
<p>这一部分的代码文件比上一部分多了好几个，大致说明一下功能：</p>
<ul>
<li>用户态文件包括<code>hello_world.c</code>、<code>lib.c</code>和<code>user.h</code>
<ul>
<li><code>hello_world.c</code>是用户写的程序，和普通程序一样，主函数是<code>int main() { ... }</code>，因为支持的系统调用有限，目前只有往标准输出打印一个Hello word！然后返回退出的功能。</li>
<li><code>lib.c</code>是包含用户程序的入口函数，在函数中执行main函数，然后调用exit()系统调用退出，另外还包含了清零bss段和系统调用函数在用户态的实现（即设置对应寄存器然后ecall的过程）。</li>
<li><code>user.h</code>包含一些类型、宏定义和函数头。</li>
</ul></li>
<li>内核态文件包括<code>batch.c</code>、<code>entry.S</code>、<code>kernel.h</code>、<code>sbicall.c</code>、<code>printf.c</code>、<code>syscall.c</code>、<code>link_app.S</code>、<code>mod.c</code>和<code>trap.S</code>
<ul>
<li><code>batch.c</code>是批处理系统的核心，包含初始化、加载程序（由于目前没有文件系统，所以用户程序都是和内核程序一起加载到内存中，等到要执行时将用户程序复制到对应的位置，从那个位置开始执行）、程序管理等功能。</li>
<li><code>entry.S</code>和实验一一样，是内核的入口点。</li>
<li><code>kernel.h</code>包含一些类型、宏定义和函数头。</li>
<li><code>sbicall.h</code>包含了对SBI的调用。</li>
<li><code>printf.c</code>和实验一一样，实现了输出函数和panic函数。</li>
<li><code>syscall.c</code>包含了对各类系统调用的实际处理。</li>
<li><code>link_app.S</code>将用户程序加载到内核程序的数据段中，并定义了一些符号供C语言调用。</li>
<li><code>mod.c</code>包含了对trap的处理，如果是系统调用则执行syscall.c里那些函数，否则说明是其他异常，直接panic。</li>
<li><code>trap.S</code>包含了进出内核态时保存现场的汇编代码。</li>
</ul></li>
</ul>
<p>为了写起来简单，代码基本没怎么对错误情况和异常进行处理，因此可能存在不少漏洞。下面是一些注意点：</p>
<p>首先是<code>lib.c</code>中的入口函数：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">();</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>__attribute__<span class="op">((</span>section<span class="op">(</span><span class="st">&quot;.text.entry&quot;</span><span class="op">)))</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> _start<span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    clear_bss<span class="op">();</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>main<span class="op">());</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>注意第二行，它等价于Rust里的<code>#[link_section = ".text.entry"]</code>，作用是把下面的函数放到字符串指定的段里，这有什么作用呢，看下用户态的链接脚本：</p>
<pre class="assembly"><code>OUTPUT_ARCH(riscv)
ENTRY(_start)

BASE_ADDRESS = 0x80400000;

SECTIONS
{
    . = BASE_ADDRESS;
    .text : {
        *(.text.entry)
        *(.text .text.*)
    }
    ...</code></pre>
<p>注意到代码段专门把<code>.text.entry</code>这一段列出来放在最前面，所以如果指定了某函数是在这个段里的，那么链接器就会把这个函数放在最前面，也就是<code>BASE_ADDRESS</code>的位置。事实上，链接脚本里的<code>ENTRY</code>在内核编译中是没有意义的，这个“入口点”的定义放在ELF文件的元信息里，而我们在使用objcopy的过程中会把ELF的元信息去掉，那么<code>ENTRY</code>指定的东西也就被去掉了。在内核编译中，指令的地址才是最重要的，如果指定用户程序从0x80400000开始执行，那么用户程序0x80400000位置的第一条指令就是其入口点。而链接脚本的段定义配合语言中的段名指定正是决定变量和函数放在哪个内存位置的方法。如果不加段名指定，像上面的程序就可能把其他的函数放在0x80400000这个位置，那么内核在执行用户程序时就会先执行这个函数，然后当这个函数运行结束后返回时内核就傻了，不知道该返回到哪，只有_start函数最后有系统调用exit，能告诉内核运行下一个用户程序。</p>
<p>然后是<code>batch.c</code>里的<code>app_init_context</code>函数：</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>TrapContext <span class="op">*</span>app_init_context<span class="op">(</span>usize entry<span class="op">,</span> usize sp<span class="op">,</span> TrapContext <span class="op">*</span>cx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    usize sstatus<span class="op">;</span> asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;csrr %0, sstatus&quot;</span><span class="op">:</span><span class="st">&quot;=r&quot;</span><span class="op">(</span>sstatus<span class="op">));</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    sstatus <span class="op">&amp;=</span> <span class="op">~(</span><span class="dv">1</span><span class="bu">L</span> <span class="op">&lt;&lt;</span> <span class="dv">8</span><span class="op">);</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">32</span><span class="op">;</span> i<span class="op">++)</span> cx<span class="op">-&gt;</span>x<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    cx<span class="op">-&gt;</span>sepc <span class="op">=</span> entry<span class="op">;</span> cx<span class="op">-&gt;</span>sstatus <span class="op">=</span> sstatus<span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    cx<span class="op">-&gt;</span>x<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> sp<span class="op">;</span> <span class="cf">return</span> cx<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>C语言调库麻烦，所以这里就硬编码了，sstatus的第8位（从0开始）指定程序所处的态，0为用户态，1为内核态。</p>
<p>然后是<code>run_next_app</code>，虽然<code>app_init_context</code>的参数和教程不太一样，但思想都是仿照教程来的：</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> run_next_app<span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    load_app<span class="op">(</span>current_app<span class="op">);</span> current_app<span class="op">++;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    __restore<span class="op">((</span>usize<span class="op">)</span>app_init_context<span class="op">(</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                APP_BASE_ADDRESS<span class="op">,</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                <span class="op">(</span>usize<span class="op">)</span>USER_TOP<span class="op">,</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                <span class="op">(</span>TrapContext <span class="op">*)(</span>KERNEL_TOP <span class="op">-</span> <span class="kw">sizeof</span><span class="op">(</span>TrapContext<span class="op">))</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                <span class="op">));</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>结合教程提出的问题：</p>
<blockquote>
<p>有兴趣的读者可以思考： sscratch 是何时被设置为内核栈顶的？</p>
</blockquote>
<p>这里谈一下这一部分栈是怎么切换的。首先明确一点，目前用到的地址全是物理地址，没有用户态和内核态之间的页表切换，riscv和x86不一样，也没有段寄存器这些东西，所以在本部分中sp寄存器指向哪哪就是当前的栈。KERNEL_TOP和USER_TOP虽然为了反映程序中栈从高向低增长的特性，用的都是“TOP”，但是为了贴合现实生活中的栈以方便理解，下面都用“内核栈底”、“用户栈底”来描述。</p>
<p>在程序启动时，和实验一一样，sp指向了<code>boot_stack</code>，那么那里就是入口函数<code>load_all</code>所用的栈。然后<code>load_all</code>调用<code>run_next_app</code>，后者调用<code>app_init_context</code>，这里对<code>TrapContext</code>的操作修改的都是内核栈的栈底，把<code>USER_TOP</code>传给了<code>TrapContext</code>里的sp寄存器，并返回了<code>TrapContext</code>的指针。</p>
<p>然后进入restore，第一句<code>mv sp, a0</code>，将<code>TrapContext</code>的指针传给了sp，这一步就相当于重置了内核栈，把内核栈重置为栈底只有一个<code>TrapContext</code>的状态，同时此处也将程序当前的栈从<code>boot_stack</code>转到内核栈了。然后各条指令都是在处理内核栈里的那一个<code>TrapContext</code>。之后<code>csrw sscratch, t2</code>将刚才传进x[2]的用户栈栈底传给sscratch寄存器，最后一句<code>csrrw sp, sscratch, sp</code>，sscratch被设置为了内核栈顶，sp也指向了用户栈底。这就是上面问题的解答。比较有趣的地方是每次<code>run_next_app</code>的时候都会重置一下内核栈，这一方面是节省空间，另一方面也是为了写起来便捷，不过在后面的程序中应该会改掉。</p>
<pre class="trap.s```有个小细节，就是因为代码里用到了宏，如果要用符号常量调用宏，须在代码最前面加上`.altmacro`，原因我也不知道，这方面资料太少了，如果不加，宏就会直接把参数替换成符号常量的名字，而不是其代表的值。"><code>
最后是`trap_handler`函数：

```c
TrapContext *trap_handler(TrapContext *cx) {
    usize scause, stval;
    asm volatile (
            &quot;csrr %0, scause\n&quot;
            &quot;csrr %1, stval\n&quot;
            :&quot;=r&quot;(scause), &quot;=r&quot;(stval)
            );
    switch (scause &amp; (~(1L &lt;&lt; 63))) {
        case 8:
            cx-&gt;sepc += 4;
            cx-&gt;x[10] = syscall(cx-&gt;x[17], cx-&gt;x[10], cx-&gt;x[11], cx-&gt;x[12]);
            break;
        default:
            panic(&quot;Other trap&quot;);
    }
    return cx;
}</code></pre>
<p>同样的，scause的处理我也进行了硬编码，scause的第0到62位存储trap的原因，8表示是来自用户态的系统调用。</p>
</article>
<span class="bg-light text-muted border boder-primary d-block p-2 text-center">
    转载请注明出处<br>
    © 2022 ZimingYuan的博客
</span>
<div style="background-color: #ebd5a1; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; pointer-events: none; opacity: 0.2;">
</div>
</body>
</html>
