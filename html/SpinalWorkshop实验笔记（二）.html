<!DOCTYPE html>
<!--
==============================================================================
           "GitHub HTML5 Pandoc Template" v2.2 — by Tristano Ajmone
==============================================================================
Copyright © Tristano Ajmone, 2017-2020, MIT License (MIT). Project's home:
- https://github.com/tajmone/pandoc-goodies
The CSS in this template reuses source code taken from the following projects:
- GitHub Markdown CSS: Copyright © Sindre Sorhus, MIT License (MIT):
  https://github.com/sindresorhus/github-markdown-css
- Primer CSS: Copyright © 2016-2017 GitHub Inc., MIT License (MIT):
  http://primercss.io/
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The MIT License
Copyright (c) Tristano Ajmone, 2017-2020 (github.com/tajmone/pandoc-goodies)
Copyright (c) Sindre Sorhus <sindresorhus@gmail.com> (sindresorhus.com)
Copyright (c) 2017 GitHub Inc.
"GitHub Pandoc HTML5 Template" is Copyright (c) Tristano Ajmone, 2017-2020,
released under the MIT License (MIT); it contains readaptations of substantial
portions of the following third party softwares:
(1) "GitHub Markdown CSS", Copyright (c) Sindre Sorhus, MIT License (MIT).
(2) "Primer CSS", Copyright (c) 2016 GitHub Inc., MIT License (MIT).
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
==============================================================================-->
<html>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>SpinalWorkshop实验笔记（二）</title>
  <style type="text/css">
@charset "UTF-8";.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";font-size:16px;line-height:1.5;word-wrap:break-word;box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto;padding:45px}.markdown-body a{color:#0366d6;background-color:transparent;text-decoration:none;-webkit-text-decoration-skip:objects}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body a:hover{text-decoration:underline}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body strong{font-weight:600}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em;margin:.67em 0;padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{padding-bottom:.3em;font-size:1.5em;border-bottom:1px solid #eaecef}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body img{border-style:none}.markdown-body svg:not(:root){overflow:hidden}.markdown-body hr{box-sizing:content-box;height:.25em;margin:24px 0;padding:0;overflow:hidden;background-color:#e1e4e8;border:0}.markdown-body hr::before{display:table;content:""}.markdown-body hr::after{display:table;clear:both;content:""}.markdown-body input{margin:0;overflow:visible;font:inherit;font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body li>p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dd{margin-left:0}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body code{font-family:SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace}.markdown-body pre{font:12px SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace;word-wrap:normal}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body table{display:block;width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body code{padding:.2em 0;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code::after,.markdown-body code::before{letter-spacing:-.2em;content:" "}.markdown-body pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:0 0;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}.markdown-body pre code::after,.markdown-body pre code::before{content:normal}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body kbd{box-shadow:inset 0 -1px 0 #959da5;display:inline-block;padding:3px 5px;font:11px/10px SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace;color:#444d56;vertical-align:middle;background-color:#fcfcfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}.markdown-body::before{display:table;content:""}.markdown-body::after{display:table;clear:both;content:""}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.Alert,.Error,.Note,.Success,.Warning{padding:11px;margin-bottom:24px;border-style:solid;border-width:1px;border-radius:4px}.Alert p,.Error p,.Note p,.Success p,.Warning p{margin-top:0}.Alert p:last-child,.Error p:last-child,.Note p:last-child,.Success p:last-child,.Warning p:last-child{margin-bottom:0}.Alert{color:#246;background-color:#e2eef9;border-color:#bac6d3}.Warning{color:#4c4a42;background-color:#fff9ea;border-color:#dfd8c2}.Error{color:#911;background-color:#fcdede;border-color:#d2b2b2}.Success{color:#22662c;background-color:#e2f9e5;border-color:#bad3be}.Note{color:#2f363d;background-color:#f6f8fa;border-color:#d5d8da}.Alert h1,.Alert h2,.Alert h3,.Alert h4,.Alert h5,.Alert h6{color:#246;margin-bottom:0}.Warning h1,.Warning h2,.Warning h3,.Warning h4,.Warning h5,.Warning h6{color:#4c4a42;margin-bottom:0}.Error h1,.Error h2,.Error h3,.Error h4,.Error h5,.Error h6{color:#911;margin-bottom:0}.Success h1,.Success h2,.Success h3,.Success h4,.Success h5,.Success h6{color:#22662c;margin-bottom:0}.Note h1,.Note h2,.Note h3,.Note h4,.Note h5,.Note h6{color:#2f363d;margin-bottom:0}.Alert h1:first-child,.Alert h2:first-child,.Alert h3:first-child,.Alert h4:first-child,.Alert h5:first-child,.Alert h6:first-child,.Error h1:first-child,.Error h2:first-child,.Error h3:first-child,.Error h4:first-child,.Error h5:first-child,.Error h6:first-child,.Note h1:first-child,.Note h2:first-child,.Note h3:first-child,.Note h4:first-child,.Note h5:first-child,.Note h6:first-child,.Success h1:first-child,.Success h2:first-child,.Success h3:first-child,.Success h4:first-child,.Success h5:first-child,.Success h6:first-child,.Warning h1:first-child,.Warning h2:first-child,.Warning h3:first-child,.Warning h4:first-child,.Warning h5:first-child,.Warning h6:first-child{margin-top:0}h1.title,p.subtitle{text-align:center}h1.title.followed-by-subtitle{margin-bottom:0}p.subtitle{font-size:1.5em;font-weight:600;line-height:1.25;margin-top:0;margin-bottom:16px;padding-bottom:.3em}div.line-block{white-space:pre-line}
  </style>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
<link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/css/bootstrap.min.css">
<script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/popper.js/1.12.9/popper.min.js" ></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/js/bootstrap.min.js" ></script>
<link rel="icon" href="/img/favicon.ico" type="image/x-icon" />
<link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top">
    <div class="container">
        <a class="navbar-brand" href="#">ZimingYuan的博客</a>
        <div class="navbar-collapse">
            <ul class="navbar-nav">
                <li class="nav-item active">
                    <a class="nav-link" href="/index.html">首页</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="/html/随笔.html">随笔</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="/html/CSP模板.html">CSP模板</a>
                </li>
            </ul>
        </div>
    </div>
</nav>
<article class="markdown-body">
<header>
<h1 class="title">SpinalWorkshop实验笔记（二）</h1>
</header>
<h3 id="概述">概述</h3>
<p>本文涉及Function、Apb3Decoder、Timer、BlackBoxAndClock四个实验。<a href="https://github.com/SpinalHDL/SpinalWorkshop">实验地址</a></p>
<h3 id="内容">内容</h3>
<h4 id="function">Function</h4>
<p>本实验的电路分两个阶段：</p>
<ul>
<li>识别字符串：用从Flow中获得的字符匹配参数字符串</li>
<li>获得数据：匹配成功后，从字符串后面获得一定量的字节构成一个整数输出</li>
</ul>
<p>难点在于识别字符串。在前面的prime实验我们知道SpinalHDL的类型不能转换为scala基础类型，所以字符串索引无法使用。这个时候我们就要借鉴前面的思路：逐个比较，结果合并。对于一个SpinalHDL类型的索引，我们不能将其转换为scala基础类型，但我们可以和scala基础类型比较，比较结果就是SpinalHDL类型了。所以我们可以构造一个scala的int类型的表（整数区间）作为中介，判断是否存在表中有一个元素和当前索引相等，同时这个元素用来索引参数字符串得到的字符和当前Flow中得到的字符相等：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">patternDetector</span><span class="op">(</span>str <span class="op">:</span> String<span class="op">)</span> <span class="op">=</span> <span class="kw">new</span> Area<span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> hit <span class="op">=</span> False</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// </span><span class="al">TODO</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> cnt <span class="op">=</span> <span class="fu">Counter</span><span class="op">(</span>str<span class="op">.</span>length<span class="op">)</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">when</span> <span class="op">(</span>io<span class="op">.</span>cmd<span class="op">.</span>valid<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">when</span><span class="op">((</span><span class="dv">0</span> until str<span class="op">.</span>length<span class="op">).</span><span class="fu">map</span><span class="op">(</span>x <span class="op">=&gt;</span> cnt <span class="op">===</span> x <span class="op">&amp;&amp;</span> io<span class="op">.</span>cmd<span class="op">.</span>payload <span class="op">===</span> <span class="fu">str</span><span class="op">(</span>x<span class="op">)).</span>orR<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">when</span> <span class="op">(</span>cnt<span class="op">.</span>willOverflowIfInc<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>          hit <span class="op">:=</span> True</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>          cnt<span class="op">.</span>clear</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> otherwise <span class="op">{</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>          cnt<span class="op">.</span>increment</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> otherwise <span class="op">{</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>        cnt<span class="op">.</span>clear</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>注意这里不能写成循环形式：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>i <span class="op">&lt;-</span> <span class="dv">0</span> until str<span class="op">.</span>length<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">when</span> <span class="op">(</span>x <span class="op">=&gt;</span> cnt <span class="op">===</span> x <span class="op">&amp;&amp;</span> io<span class="op">.</span>cmd<span class="op">.</span>payload <span class="op">===</span> <span class="fu">str</span><span class="op">(</span>x<span class="op">))</span> <span class="op">{</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">when</span> <span class="op">(</span>cnt<span class="op">.</span>willOverflowIfInc<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>          hit <span class="op">:=</span> True</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>          cnt<span class="op">.</span>clear</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> otherwise <span class="op">{</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>          cnt<span class="op">.</span>increment</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> otherwise <span class="op">{</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        cnt<span class="op">.</span>clear</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>虽然表面上是等价的，都是把循环/区间展开，但是在下面这种情况下cnt在循环中会改变，整个意思就变了。而电路中又没有break语句用，这个地方如果是在软件中的话应该是非常明显的bug，但硬件上我就花了很长时间才发现，说明还是经验太少了。</p>
<p>获得数据阶段就不是很难了：</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">valueLoader</span><span class="op">(</span>start <span class="op">:</span> Bool<span class="op">,</span>that <span class="op">:</span> Data<span class="op">)=</span> <span class="kw">new</span> Area<span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">require</span><span class="op">(</span><span class="fu">widthOf</span><span class="op">(</span>that<span class="op">)</span> <span class="op">%</span> <span class="fu">widthOf</span><span class="op">(</span>io<span class="op">.</span>cmd<span class="op">.</span>payload<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="co">//You can make the assumption that the &#39;that&#39; width is alwas an mulitple of 8</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// </span><span class="al">TODO</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> bytecnt <span class="op">=</span> <span class="fu">widthOf</span><span class="op">(</span>that<span class="op">)</span> <span class="op">/</span> <span class="fu">widthOf</span><span class="op">(</span>io<span class="op">.</span>cmd<span class="op">.</span>payload<span class="op">)</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> hit <span class="op">=</span> <span class="fu">Reg</span><span class="op">(</span>False<span class="op">)</span> <span class="fu">setWhen</span><span class="op">(</span>start<span class="op">)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> cnt <span class="op">=</span> <span class="fu">Counter</span><span class="op">(</span>bytecnt<span class="op">)</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> data <span class="op">=</span> <span class="fu">Reg</span><span class="op">(</span><span class="fu">Bits</span><span class="op">(</span><span class="fu">widthOf</span><span class="op">(</span>that<span class="op">)</span> bits<span class="op">))</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">when</span> <span class="op">(</span>hit <span class="op">&amp;&amp;</span> io<span class="op">.</span>cmd<span class="op">.</span>valid<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>      data<span class="op">.</span><span class="fu">subdivideIn</span><span class="op">(</span>bytecnt slices<span class="op">)(</span>cnt<span class="op">)</span> <span class="op">:=</span> io<span class="op">.</span>cmd<span class="op">.</span>payload</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>      hit<span class="op">.</span><span class="fu">clearWhen</span><span class="op">(</span>cnt<span class="op">.</span>willOverflowIfInc<span class="op">)</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>      cnt<span class="op">.</span>increment</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    that <span class="op">:=</span> data</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>注意<code>data.subdivideIn(bytecnt slices)(cnt) := io.cmd.payload</code>切片后索引的变量cnt必须符合切片的块数，比如切片块数是8，cnt就必须是3位二进制数。奇怪的是，当that的位数为8的时候，bytecnt等于1，声明出的Counter的范围只有一个数：0。相当于是0位二进制数，非常反直觉的定义，一开始我很纠结，后来发现并不影响结果，但还是觉得很别扭。</p>
<h4 id="apb3decoder">Apb3Decoder</h4>
<p>这个实验评测需要用到python，注意用来评测的python库cocotb的版本必须是1.4.0及以下的，不然会有兼容性问题。</p>
<p>这个实验主要是要明白这个译码器做什么的，其实很简单，就是在一组子设备中找到对应地址区间的子设备，这个子设备的片选信号等于输入设备（父设备）的片选信号，同时父设备的三个接收信号PRDATA、PREADY和PSLERROR需要接收子设备的相应信号；其他设备就直接连：</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">//</span><span class="al">TODO</span><span class="co"> fully asynchronous apb3 decoder</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  io<span class="op">.</span>input<span class="op">.</span>PRDATA <span class="op">:=</span> io<span class="op">.</span><span class="fu">outputs</span><span class="op">(</span><span class="dv">0</span><span class="op">).</span>PRDATA</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  io<span class="op">.</span>input<span class="op">.</span>PREADY <span class="op">:=</span> io<span class="op">.</span><span class="fu">outputs</span><span class="op">(</span><span class="dv">0</span><span class="op">).</span>PREADY</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>apbConfig<span class="op">.</span>useSlaveError<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    io<span class="op">.</span>input<span class="op">.</span>PSLVERROR <span class="op">:=</span> io<span class="op">.</span><span class="fu">outputs</span><span class="op">(</span><span class="dv">0</span><span class="op">).</span>PSLVERROR</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>i <span class="op">&lt;-</span> <span class="dv">0</span> until outputsMapping<span class="op">.</span>length<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">when</span> <span class="op">(</span><span class="fu">outputsMapping</span><span class="op">(</span>i<span class="op">).</span><span class="fu">hit</span><span class="op">(</span>io<span class="op">.</span>input<span class="op">.</span>PADDR<span class="op">))</span> <span class="op">{</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>      io<span class="op">.</span><span class="fu">outputs</span><span class="op">(</span>i<span class="op">).</span>PSEL <span class="op">:=</span> io<span class="op">.</span>input<span class="op">.</span>PSEL</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>      io<span class="op">.</span>input<span class="op">.</span>PRDATA <span class="op">:=</span> io<span class="op">.</span><span class="fu">outputs</span><span class="op">(</span>i<span class="op">).</span>PRDATA</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>      io<span class="op">.</span>input<span class="op">.</span>PREADY <span class="op">:=</span> io<span class="op">.</span><span class="fu">outputs</span><span class="op">(</span>i<span class="op">).</span>PREADY</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>apbConfig<span class="op">.</span>useSlaveError<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        io<span class="op">.</span>input<span class="op">.</span>PSLVERROR <span class="op">:=</span> io<span class="op">.</span><span class="fu">outputs</span><span class="op">(</span>i<span class="op">).</span>PSLVERROR</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> otherwise <span class="op">{</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>      io<span class="op">.</span><span class="fu">outputs</span><span class="op">(</span>i<span class="op">).</span>PSEL <span class="op">:=</span> <span class="dv">0</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    io<span class="op">.</span><span class="fu">outputs</span><span class="op">(</span>i<span class="op">).</span>PENABLE <span class="op">:=</span> io<span class="op">.</span>input<span class="op">.</span>PENABLE</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    io<span class="op">.</span><span class="fu">outputs</span><span class="op">(</span>i<span class="op">).</span>PADDR <span class="op">:=</span> io<span class="op">.</span>input<span class="op">.</span>PADDR</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    io<span class="op">.</span><span class="fu">outputs</span><span class="op">(</span>i<span class="op">).</span>PWRITE <span class="op">:=</span> io<span class="op">.</span>input<span class="op">.</span>PWRITE</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    io<span class="op">.</span><span class="fu">outputs</span><span class="op">(</span>i<span class="op">).</span>PWDATA <span class="op">:=</span> io<span class="op">.</span>input<span class="op">.</span>PWDATA</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>这里需要注意io.input的三个接收信号在使用时不能空置，即使是在整个for循环中一个子设备都没对上，也要强行赋一个值，不然会报latch error。文档里latch error介绍的是组合逻辑回路错误，实际上出现这种错误更多的原因是线路空置。一个类似的错误是寄存器没有初始化，这种错误一般不会像上面那种可以在生成电路时检测出来，而是直接导致逻辑错误。在普通评测时只会输出一个错误的值，而用python评测时会输出高阻的xxx。可能和两者后端的模拟器有关，前者时verilator，后者是icarus verilog。显然是后者更容易检查出错误，不过我觉得SpinalHDL应该出一个寄存器没赋初值就报错的生成选项，从根本上杜绝这种错误。</p>
<h4 id="timer">Timer</h4>
<p>这个实验有两个重点，一个是BusSlaveFactory对象的使用。我一开始一直不明白这个对象是干嘛用的，毕竟是fpga初学者。目前看来的作用应该是为地址映射提供便利，像前面pwm实验中就有根据地址读写电路内寄存器的需求，用了这个对象映射一个地址就是一句话的事；另一个是一连串信号源的处理，父模块可以将一连串信号都传入子模块由子模块来进行计算和连接：</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>   <span class="kw">def</span> <span class="fu">driveFrom</span><span class="op">(</span>busCtrl <span class="op">:</span> BusSlaveFactory<span class="op">,</span>baseAddress <span class="op">:</span> BigInt<span class="op">)(</span>ticks <span class="op">:</span> <span class="bu">Seq</span><span class="op">[</span>Bool<span class="op">],</span>clears <span class="op">:</span> <span class="bu">Seq</span><span class="op">[</span>Bool<span class="op">])</span> <span class="op">=</span> <span class="kw">new</span> Area <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//</span><span class="al">TODO</span><span class="co"> phase 2</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> clear <span class="op">=</span> False</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> ticksEnable <span class="op">=</span> busCtrl<span class="op">.</span><span class="fu">createReadAndWrite</span><span class="op">(</span><span class="fu">Bits</span><span class="op">(</span>ticks<span class="op">.</span>length bits<span class="op">),</span> baseAddress <span class="op">+</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">)</span> <span class="fu">init</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> clearsEnable <span class="op">=</span> busCtrl<span class="op">.</span><span class="fu">createReadAndWrite</span><span class="op">(</span><span class="fu">Bits</span><span class="op">(</span>clears<span class="op">.</span>length bits<span class="op">),</span> baseAddress <span class="op">+</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">16</span><span class="op">)</span> <span class="fu">init</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    busCtrl<span class="op">.</span><span class="fu">driveAndRead</span><span class="op">(</span>io<span class="op">.</span>limit<span class="op">,</span> baseAddress <span class="op">+</span> <span class="dv">4</span><span class="op">)</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    clear<span class="op">.</span><span class="fu">setWhen</span><span class="op">(</span>busCtrl<span class="op">.</span><span class="fu">isWriting</span><span class="op">(</span>baseAddress <span class="op">+</span> <span class="dv">4</span><span class="op">))</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    busCtrl<span class="op">.</span><span class="fu">read</span><span class="op">(</span>io<span class="op">.</span>value<span class="op">,</span> baseAddress <span class="op">+</span> <span class="dv">8</span><span class="op">)</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    clear<span class="op">.</span><span class="fu">setWhen</span><span class="op">(</span>busCtrl<span class="op">.</span><span class="fu">isWriting</span><span class="op">(</span>baseAddress <span class="op">+</span> <span class="dv">8</span><span class="op">))</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    io<span class="op">.</span>tick <span class="op">:=</span> <span class="op">(</span>ticksEnable <span class="op">&amp;</span> ticks<span class="op">.</span>asBits<span class="op">).</span>orR</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    io<span class="op">.</span>clear <span class="op">:=</span> <span class="op">(</span>clearsEnable <span class="op">&amp;</span> clears<span class="op">.</span>asBits<span class="op">).</span>orR <span class="op">|</span> clear</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>createReadAndWrite创建一个可读可写的寄存器并映射；driveAndRead是映射一个已有的端口，并设置为可读可写；read也是映射一个已有的端口，但设置为只读。isWriting用于捕获对地址的写请求。</p>
<p>计时器的电路代码非常简单：</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">//</span><span class="al">TODO</span><span class="co"> phase 1</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> v <span class="op">=</span> <span class="fu">Counter</span><span class="op">(</span>width bits<span class="op">)</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">when</span> <span class="op">(</span>io<span class="op">.</span>clear<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    v<span class="op">.</span>clear</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="fu">elsewhen</span> <span class="op">(</span>io<span class="op">.</span>tick <span class="op">&amp;&amp;</span> v <span class="op">=/=</span> io<span class="op">.</span>limit<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    v<span class="op">.</span>increment</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  io<span class="op">.</span>full <span class="op">:=</span> v <span class="op">===</span> io<span class="op">.</span>limit</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  io<span class="op">.</span>value <span class="op">:=</span> v</span></code></pre></div>
<h4 id="blackboxandclock">BlackBoxAndClock</h4>
<p>本实验的重点是blackbox的使用，这部分SpinalHDL的<a href="https://spinalhdl.github.io/SpinalDoc-RTD/master/SpinalHDL/Structuring/blackbox.html">文档</a>写得非常详细，所以实际上不难：</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">// </span><span class="al">TODO</span><span class="co"> define Generics</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addGeneric</span><span class="op">(</span><span class="st">&quot;wordWidth&quot;</span><span class="op">,</span> wordWidth<span class="op">)</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addGeneric</span><span class="op">(</span><span class="st">&quot;addressWidth&quot;</span><span class="op">,</span> addressWidth<span class="op">)</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// </span><span class="al">TODO</span><span class="co"> define IO</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> io <span class="op">=</span> <span class="kw">new</span> Bundle <span class="op">{</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> wr <span class="op">=</span> <span class="kw">new</span> Bundle <span class="op">{</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">val</span> clk <span class="op">=</span> in Bool</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">val</span> en   <span class="op">=</span> in Bool</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">val</span> addr <span class="op">=</span> in <span class="fu">UInt</span><span class="op">(</span>addressWidth bit<span class="op">)</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">val</span> data <span class="op">=</span> in <span class="fu">Bits</span><span class="op">(</span>wordWidth bit<span class="op">)</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> rd <span class="op">=</span> <span class="kw">new</span> Bundle <span class="op">{</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">val</span> clk <span class="op">=</span> in Bool</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">val</span> en   <span class="op">=</span> in Bool</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">val</span> addr <span class="op">=</span> in <span class="fu">UInt</span><span class="op">(</span>addressWidth bit<span class="op">)</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">val</span> data <span class="op">=</span> out <span class="fu">Bits</span><span class="op">(</span>wordWidth bit<span class="op">)</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// </span><span class="al">TODO</span><span class="co"> define ClockDomains mappings</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapClockDomain</span><span class="op">(</span>writeClock<span class="op">,</span> io<span class="op">.</span>wr<span class="op">.</span>clk<span class="op">)</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapClockDomain</span><span class="op">(</span>readClock<span class="op">,</span> io<span class="op">.</span>rd<span class="op">.</span>clk<span class="op">)</span></span></code></pre></div>
<p>基本上就是分三步走：</p>
<ol type="1">
<li>定义参数，用addGeneric，指定verilog模块中的parameter</li>
<li>定义接口，这里的层次结构要和verilog模块里的端口名相符合，比如上面代码里的io.wr.clk对应的就是verilog里的io_wr_clk，如果要违反命名规范需要特殊设置，文档里也有写</li>
<li>映射时钟，将当前的时钟或者你定义的时钟映射到verilog的时钟端口上</li>
</ol>
<p>然后是电路定义，这个虽然不是重点，但是我却栽了很大的跟头，花了很长时间去研究这个时序。之前verilog课的考试也是栽在时序上。这里我根据波形总结了三条定律：</p>
<ol type="1">
<li><p>对于when (cond) {xxx}这样的语句，xxx的触发在cond变为高电平之后的<strong>下次</strong>时钟上升沿。举例来说，假设第一个上升沿cond变成了高电平，那么xxx的第一次触发在第二个上升沿</p></li>
<li><p>内存的读数据端口会在读地址变化的<strong>下次</strong>时钟上升沿才产生变化</p></li>
<li><p>在时钟上升沿时，首先会对内存读数据端口取值，接着读数据端口更新，最后寄存器产生变化</p></li>
</ol>
<p>这样我们就可以分析下面的代码了：</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> sumArea <span class="op">=</span> <span class="kw">new</span> <span class="fu">ClockingArea</span><span class="op">(</span>sumClock<span class="op">){</span>                                                                              <span class="co">// </span><span class="al">TODO</span><span class="co"> define the memory read + summing logic</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> sum <span class="op">=</span> <span class="fu">Reg</span><span class="op">(</span>io<span class="op">.</span>sum<span class="op">.</span>value<span class="op">)</span> <span class="fu">init</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    io<span class="op">.</span>sum<span class="op">.</span>value <span class="op">:=</span> sum</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> readAddr <span class="op">=</span> <span class="fu">Counter</span><span class="op">(</span><span class="fu">widthOf</span><span class="op">(</span>io<span class="op">.</span>wr<span class="op">.</span>addr<span class="op">)</span> bits<span class="op">)</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> cntEnable <span class="op">=</span> <span class="fu">RegInit</span><span class="op">(</span>False<span class="op">)</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> sumEnable <span class="op">=</span> <span class="fu">RegNext</span><span class="op">(</span>cntEnable<span class="op">)</span> <span class="fu">init</span><span class="op">(</span>False<span class="op">)</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    ram<span class="op">.</span>io<span class="op">.</span>rd<span class="op">.</span>en <span class="op">:=</span> cntEnable</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    ram<span class="op">.</span>io<span class="op">.</span>rd<span class="op">.</span>addr <span class="op">:=</span> readAddr</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">when</span> <span class="op">(</span>io<span class="op">.</span>sum<span class="op">.</span>start<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>      cntEnable<span class="op">.</span>set</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>      readAddr<span class="op">.</span>clear</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>      sum<span class="op">.</span>clearAll</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">when</span> <span class="op">(</span>cntEnable<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>      readAddr<span class="op">.</span>increment</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">when</span> <span class="op">(</span>sumEnable<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>      sum <span class="op">:=</span> sum <span class="op">+</span> ram<span class="op">.</span>io<span class="op">.</span>rd<span class="op">.</span>data<span class="op">.</span>asUInt</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>      cntEnable<span class="op">.</span><span class="fu">clearWhen</span><span class="op">(</span>readAddr<span class="op">.</span>willOverflowIfInc<span class="op">)</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    io<span class="op">.</span>sum<span class="op">.</span>done<span class="op">.</span>clear</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    io<span class="op">.</span>sum<span class="op">.</span>done<span class="op">.</span><span class="fu">setWhen</span><span class="op">(</span>sumEnable<span class="op">.</span><span class="fu">fall</span><span class="op">(</span>False<span class="op">))</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>设io.sum.start被触发是第0时钟上升沿，根据定律1，cntEnable被置1和readAddr清零是第1上升沿。则在第2上升沿，readAddr变为1，且sumEnable紧随cntEnable被置1，又根据定律2，这时ram.io.rd.data才是地址为0的值。在第3上升沿，根据定律3，首先取ram.io.rd.data的值加到sum上，然后ram.io.rd.data更新为地址为1的值，最后readAddr变为2。在第4上升沿，同样地址为1的值被加到sum上，再更新内存读端口，再更新计数器，以此类推。</p>
<p>可以看出，每次加在sum寄存器上的值是当前计数器减2作为地址得到的值，这也是为什么要两个enable的原因。对于结束时的信号，也得仔细分析，设readAddr被加到0xFF的那个上升沿为第0上升沿，这时sum加上了地址为0xFD的内存值，然后端口更新为地址为0xFE的内存值。根据定律1，在第1上升沿，cntEnable清零，同时sum加上地址为0xFE的内存值，端口更新为地址为0xFF的内存值，readAddr更新为0。这时io.sum.done不能置1，因为sum还没加完。在第2上升沿，sumEnable随之清零，同时sum加上地址为0xFF的内存值，端口更新，readAddr已经不会加了，io.sum.done在sumEnable清零的瞬间置1。这里只能用“清零的瞬间”这个条件，因为用高电平还是低电平判断怎么也不合适。</p>
<p>然后有两个注意的地方：</p>
<ul>
<li><p>布尔型寄存器设置初始值要用RegInit或者Reg(Bool) init()，我以前以为Reg(False)就是赋初值为False了，结果并不是，只是说明这个寄存器和False是同类型而已</p></li>
<li><p>关于xxx.fall函数，我看<a href="https://github.com/SpinalHDL/SpinalHDL/blob/dev/core/src/main/scala/spinal/core/Bool.scala">SpinalHDL源代码</a>里有两个重载：</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">/**</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">*</span> Falling edge detection of this with an initial value</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">*</span> <span class="co">@</span>example<span class="re">{{{</span> val res <span class="co">=</span> myBool<span class="co">.</span>fall<span class="co">(</span>False<span class="co">)</span> <span class="re">}}}</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">    * @</span>param initAt the initial value</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">*</span> <span class="co">@</span>return a Bool</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">*/</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">fall</span><span class="op">(</span>initAt<span class="op">:</span> Bool<span class="op">):</span> Bool <span class="op">=</span> <span class="op">!</span> <span class="kw">this</span> <span class="op">&amp;&amp;</span> <span class="fu">RegNext</span><span class="op">(</span><span class="kw">this</span><span class="op">).</span><span class="fu">init</span><span class="op">(</span>initAt<span class="op">)</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">/**</span> Falling edge detection <span class="co">*/</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">fall</span><span class="op">():</span> Bool <span class="op">=</span> <span class="op">!</span> <span class="kw">this</span> <span class="op">&amp;&amp;</span> <span class="fu">RegNext</span><span class="op">(</span><span class="kw">this</span><span class="op">)</span></span></code></pre></div>
<p>实现方式是定义一个寄存器作为当前信号的后继，这样当前信号下降的时候后继寄存器还没下降。我一开始没仔细看，选了后面那个没参数的重载。结果那个后继寄存器没初始化！众所周知，没有初始化会导致一些匪夷所思的结果，我就遇到了诸如when (cond) {do A} otherwise {do B}和when (!cond) {do B} otherwise {do A}结果不一样和计数器只能用Reg不能用Counter之类的诡异问题。最后看了波形才明白，原因是后继寄存器一开始为1，所以只要当前信号是低电平都会返回1。我只想吐槽一句，写第二个重载的人是不是SpinalHDL项目组里的内鬼，这不是纯坑爹吗？事实上，我觉得初始值直接默认为假就可以了，根本就没有初始值为真能返回正确结果的情况。</p></li>
</ul>
</article>
<span class="bg-light text-muted border boder-primary d-block p-2 text-center">
    转载请注明出处<br>
    © 2022 ZimingYuan的博客
</span>
<div style="background-color: #ebd5a1; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; pointer-events: none; opacity: 0.2;">
</div>
</body>
</html>
