<!DOCTYPE html>
<!--
==============================================================================
           "GitHub HTML5 Pandoc Template" v2.2 — by Tristano Ajmone
==============================================================================
Copyright © Tristano Ajmone, 2017-2020, MIT License (MIT). Project's home:
- https://github.com/tajmone/pandoc-goodies
The CSS in this template reuses source code taken from the following projects:
- GitHub Markdown CSS: Copyright © Sindre Sorhus, MIT License (MIT):
  https://github.com/sindresorhus/github-markdown-css
- Primer CSS: Copyright © 2016-2017 GitHub Inc., MIT License (MIT):
  http://primercss.io/
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The MIT License
Copyright (c) Tristano Ajmone, 2017-2020 (github.com/tajmone/pandoc-goodies)
Copyright (c) Sindre Sorhus <sindresorhus@gmail.com> (sindresorhus.com)
Copyright (c) 2017 GitHub Inc.
"GitHub Pandoc HTML5 Template" is Copyright (c) Tristano Ajmone, 2017-2020,
released under the MIT License (MIT); it contains readaptations of substantial
portions of the following third party softwares:
(1) "GitHub Markdown CSS", Copyright (c) Sindre Sorhus, MIT License (MIT).
(2) "Primer CSS", Copyright (c) 2016 GitHub Inc., MIT License (MIT).
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
==============================================================================-->
<html>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>rCore-Tutorial-Book-v3学习笔记（六）</title>
  <style type="text/css">
@charset "UTF-8";.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";font-size:16px;line-height:1.5;word-wrap:break-word;box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto;padding:45px}.markdown-body a{color:#0366d6;background-color:transparent;text-decoration:none;-webkit-text-decoration-skip:objects}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body a:hover{text-decoration:underline}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body strong{font-weight:600}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em;margin:.67em 0;padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{padding-bottom:.3em;font-size:1.5em;border-bottom:1px solid #eaecef}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body img{border-style:none}.markdown-body svg:not(:root){overflow:hidden}.markdown-body hr{box-sizing:content-box;height:.25em;margin:24px 0;padding:0;overflow:hidden;background-color:#e1e4e8;border:0}.markdown-body hr::before{display:table;content:""}.markdown-body hr::after{display:table;clear:both;content:""}.markdown-body input{margin:0;overflow:visible;font:inherit;font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body li>p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dd{margin-left:0}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body code{font-family:SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace}.markdown-body pre{font:12px SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace;word-wrap:normal}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body table{display:block;width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body code{padding:.2em 0;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code::after,.markdown-body code::before{letter-spacing:-.2em;content:" "}.markdown-body pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:0 0;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}.markdown-body pre code::after,.markdown-body pre code::before{content:normal}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body kbd{box-shadow:inset 0 -1px 0 #959da5;display:inline-block;padding:3px 5px;font:11px/10px SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace;color:#444d56;vertical-align:middle;background-color:#fcfcfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}.markdown-body::before{display:table;content:""}.markdown-body::after{display:table;clear:both;content:""}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.Alert,.Error,.Note,.Success,.Warning{padding:11px;margin-bottom:24px;border-style:solid;border-width:1px;border-radius:4px}.Alert p,.Error p,.Note p,.Success p,.Warning p{margin-top:0}.Alert p:last-child,.Error p:last-child,.Note p:last-child,.Success p:last-child,.Warning p:last-child{margin-bottom:0}.Alert{color:#246;background-color:#e2eef9;border-color:#bac6d3}.Warning{color:#4c4a42;background-color:#fff9ea;border-color:#dfd8c2}.Error{color:#911;background-color:#fcdede;border-color:#d2b2b2}.Success{color:#22662c;background-color:#e2f9e5;border-color:#bad3be}.Note{color:#2f363d;background-color:#f6f8fa;border-color:#d5d8da}.Alert h1,.Alert h2,.Alert h3,.Alert h4,.Alert h5,.Alert h6{color:#246;margin-bottom:0}.Warning h1,.Warning h2,.Warning h3,.Warning h4,.Warning h5,.Warning h6{color:#4c4a42;margin-bottom:0}.Error h1,.Error h2,.Error h3,.Error h4,.Error h5,.Error h6{color:#911;margin-bottom:0}.Success h1,.Success h2,.Success h3,.Success h4,.Success h5,.Success h6{color:#22662c;margin-bottom:0}.Note h1,.Note h2,.Note h3,.Note h4,.Note h5,.Note h6{color:#2f363d;margin-bottom:0}.Alert h1:first-child,.Alert h2:first-child,.Alert h3:first-child,.Alert h4:first-child,.Alert h5:first-child,.Alert h6:first-child,.Error h1:first-child,.Error h2:first-child,.Error h3:first-child,.Error h4:first-child,.Error h5:first-child,.Error h6:first-child,.Note h1:first-child,.Note h2:first-child,.Note h3:first-child,.Note h4:first-child,.Note h5:first-child,.Note h6:first-child,.Success h1:first-child,.Success h2:first-child,.Success h3:first-child,.Success h4:first-child,.Success h5:first-child,.Success h6:first-child,.Warning h1:first-child,.Warning h2:first-child,.Warning h3:first-child,.Warning h4:first-child,.Warning h5:first-child,.Warning h6:first-child{margin-top:0}h1.title,p.subtitle{text-align:center}h1.title.followed-by-subtitle{margin-bottom:0}p.subtitle{font-size:1.5em;font-weight:600;line-height:1.25;margin-top:0;margin-bottom:16px;padding-bottom:.3em}div.line-block{white-space:pre-line}
  </style>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
<link rel="stylesheet" href="https://cdn.bootcss.com/twitter-bootstrap/4.1.0/css/bootstrap.min.css">
<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/popper.js/1.12.9/popper.min.js" ></script>
<script src="https://cdn.bootcss.com/twitter-bootstrap/4.1.0/js/bootstrap.min.js" ></script>
<link rel="icon" href="/img/favicon.ico" type="image/x-icon" />
<link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top">
    <div class="container">
        <a class="navbar-brand" href="#">ZimingYuan的博客</a>
        <div class="navbar-collapse">
            <ul class="navbar-nav">
                <li class="nav-item active">
                    <a class="nav-link" href="/index.html">首页</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="/html/随笔.html">随笔</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="/html/CSP模板.html">CSP模板</a>
                </li>
            </ul>
        </div>
    </div>
</nav>
<article class="markdown-body">
<header>
<h1 class="title">rCore-Tutorial-Book-v3学习笔记（六）</h1>
</header>
<h3 id="概述">概述</h3>
<p>第六部分是实现基本的文件数据结构、标准输入输出文件和管道文件。相对来讲比较简单，不过因为每个进程的文件描述符表需要用一个既能动态扩增又能直接索引的数据结构，所以我顺便自己实现了一个简单的vector，并利用相同的思想实现了一个队列，使用非常简单，所以又把queue.h换掉了。</p>
<h3 id="内容">内容</h3>
<p>首先是vector和queue，我采用了倍增扩容的方法，即容量满了以后扩大一倍。为了保证空间足够，需要将其包含的数据类型的大小作为属性存入结构体，开辟空间和复制操作的时候都需要乘以该属性，这里以vector和queue的push函数为例：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> vector_push<span class="op">(</span><span class="kw">struct</span> vector <span class="op">*</span>v<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>d<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>v<span class="op">-&gt;</span>size <span class="op">==</span> v<span class="op">-&gt;</span>capacity<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>        v<span class="op">-&gt;</span>capacity <span class="op">&lt;&lt;=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> <span class="op">*</span>t <span class="op">=</span> bd_malloc<span class="op">(</span>v<span class="op">-&gt;</span>capacity <span class="op">*</span> v<span class="op">-&gt;</span>dsize<span class="op">);</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>        memcpy<span class="op">(</span>t<span class="op">,</span> v<span class="op">-&gt;</span>buffer<span class="op">,</span> v<span class="op">-&gt;</span>size <span class="op">*</span> v<span class="op">-&gt;</span>dsize<span class="op">);</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>        bd_free<span class="op">(</span>v<span class="op">-&gt;</span>buffer<span class="op">);</span> v<span class="op">-&gt;</span>buffer <span class="op">=</span> t<span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    memcpy<span class="op">(</span>v<span class="op">-&gt;</span>buffer <span class="op">+</span> <span class="op">(</span>v<span class="op">-&gt;</span>size<span class="op">++)</span> <span class="op">*</span> v<span class="op">-&gt;</span>dsize<span class="op">,</span> d<span class="op">,</span> v<span class="op">-&gt;</span>dsize<span class="op">);</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> queue_push<span class="op">(</span><span class="kw">struct</span> queue <span class="op">*</span>q<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>d<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>q<span class="op">-&gt;</span>size <span class="op">==</span> q<span class="op">-&gt;</span>capacity<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        q<span class="op">-&gt;</span>capacity <span class="op">&lt;&lt;=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> <span class="op">*</span>t <span class="op">=</span> bd_malloc<span class="op">(</span>q<span class="op">-&gt;</span>capacity <span class="op">*</span> q<span class="op">-&gt;</span>dsize<span class="op">);</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>        memcpy<span class="op">(</span>t<span class="op">,</span> q<span class="op">-&gt;</span>buffer<span class="op">,</span> q<span class="op">-&gt;</span>tail <span class="op">*</span> q<span class="op">-&gt;</span>dsize<span class="op">);</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>        memcpy<span class="op">(</span>t <span class="op">+</span> <span class="op">(</span>q<span class="op">-&gt;</span>capacity <span class="op">-</span> <span class="op">(</span>q<span class="op">-&gt;</span>size <span class="op">-</span> q<span class="op">-&gt;</span>front<span class="op">))</span> <span class="op">*</span> q<span class="op">-&gt;</span>dsize<span class="op">,</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>                q<span class="op">-&gt;</span>buffer <span class="op">+</span> q<span class="op">-&gt;</span>front <span class="op">*</span> q<span class="op">-&gt;</span>dsize<span class="op">,</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>                <span class="op">(</span>q<span class="op">-&gt;</span>size <span class="op">-</span> q<span class="op">-&gt;</span>front<span class="op">)</span> <span class="op">*</span> q<span class="op">-&gt;</span>dsize<span class="op">);</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>        q<span class="op">-&gt;</span>front <span class="op">=</span> q<span class="op">-&gt;</span>capacity <span class="op">-</span> <span class="op">(</span>q<span class="op">-&gt;</span>size <span class="op">-</span> q<span class="op">-&gt;</span>front<span class="op">);</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>        bd_free<span class="op">(</span>q<span class="op">-&gt;</span>buffer<span class="op">);</span> q<span class="op">-&gt;</span>buffer <span class="op">=</span> t<span class="op">;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    memcpy<span class="op">(</span>q<span class="op">-&gt;</span>buffer <span class="op">+</span> q<span class="op">-&gt;</span>tail <span class="op">*</span> q<span class="op">-&gt;</span>dsize<span class="op">,</span> d<span class="op">,</span> q<span class="op">-&gt;</span>dsize<span class="op">);</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    q<span class="op">-&gt;</span>tail <span class="op">=</span> <span class="op">(</span>q<span class="op">-&gt;</span>tail <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">%</span> q<span class="op">-&gt;</span>capacity<span class="op">;</span> q<span class="op">-&gt;</span>size<span class="op">++;</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>vector的操作很直观，queue要麻烦一些，为了节省空间，queue用的是循环队列，当队列满时，头索引和尾索引必然相等，因为尾索引是向右增加，头索引是像左减少的，所以扩容的时候需要将原缓冲区最左侧到尾索引的数据复制到新缓冲区的最左侧，将原缓冲区头索引到最右侧的数据复制到新缓冲区的最右侧，这时候就得计算好复制到新缓冲区的起始位置。</p>
<p>然后是文件描述符的设计，rCore很好地利用了rust语言的面向对象特性，让File对象“继承”（我不确定rust语言里这个行为叫什么，大概类似于java里继承抽象类）管道、磁盘文件、设备等对象，这样File对象就只要实现一些最基本的方法和属性，比如定义文件写和文件读函数的指针，具体的属性和方法，如管道释放方法、管道读写权限、管道对应缓冲区、磁盘文件索引之类就通过“继承”赋予给File对象；xv6就比较朴素，在文件描述符里对应了多种多样的属性，但是没有定义函数指针，而是由统一的读写函数通过文件描述符里的文件类型属性判断；我则综合了两者，给文件描述符定义了包括读、写、释放、复制多个函数的指针，这样在读、写、释放的系统调用中就不用判断文件类型，而是调用对应的函数指针即可，同时也在文件描述符中额外定义了一个void类型的指针，用来指向这个文件“绑定”的数据，比如是管道文件，这个指针就指向一个管道。在调用文件处理函数指针的时候把文件指针传进去，由不同的函数来对这个“绑定”指针进行不同的解释，算是一种伪泛型吧。</p>
<p>这里还有一点要注意的，就是文件的引用计数问题。这个问题对于rCore和xv6的意义不同。对于rCore来说，这个计数不是针对于单个的文件描述符，而是针对于文件描述符所产生的跨进程资源。比如管道文件，虽然每个进程各自持有，释放也各自释放就行，但是管道包含一个用来传输数据的缓冲队列，这个缓冲队列就是跨进程资源。这就需要引用计数，对于每个缓冲队列记录自己有多少个“管口”，当所有“管口”被关闭时，即没有管道引用它时，就要释放这个缓冲队列。这里rust又拿下一城：拥有内置了引用计数功能的智能指针，不需要显式地处理引用计数问题。再看看xv6，xv6是父子进程共享一个文件描述符，所以引用计数是文件描述符的一个属性，每次进程fork都会增加一次引用，释放文件会减少一次引用，当引用为0时将文件描述符及其对应的资源释放。我在文件描述符和进程的关系上遵循的是rCore，即每个进程持有一个独立的文件描述符，而把引用计数属性放在需要被释放的结构体中，比如这里就给管道添加了引用计数属性，同时定义了管道释放和复制的方法对其指向的缓冲区引用计数进行修改，这一步就比较像xv6，然后把这两个函数填入文件描述符的函数指针中，由fork函数和文件关闭函数调用。</p>
<p>这里给出管道相关的创建、读写、复制、释放函数：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>usize pipe_read<span class="op">(</span>File <span class="op">*</span>self<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>buffer<span class="op">,</span> usize len<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    Pipe <span class="op">*</span>p <span class="op">=</span> <span class="op">(</span>Pipe <span class="op">*)</span>self<span class="op">-&gt;</span>bind<span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> len<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span>queue_empty<span class="op">(&amp;</span>p<span class="op">-&gt;</span>q<span class="op">))</span> <span class="op">{</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>p<span class="op">-&gt;</span>wrefcnt <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                buffer<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="ch">&#39;\0&#39;</span><span class="op">;</span> <span class="cf">return</span> i<span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>            suspend_current_and_run_next<span class="op">();</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        buffer<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="op">*(</span><span class="dt">char</span> <span class="op">*)</span>queue_front<span class="op">(&amp;</span>p<span class="op">-&gt;</span>q<span class="op">);</span> queue_pop<span class="op">(&amp;</span>p<span class="op">-&gt;</span>q<span class="op">);</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> len<span class="op">;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>usize pipe_write<span class="op">(</span>File <span class="op">*</span>self<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>buffer<span class="op">,</span> usize len<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    Pipe <span class="op">*</span>p <span class="op">=</span> <span class="op">(</span>Pipe <span class="op">*)</span>self<span class="op">-&gt;</span>bind<span class="op">;</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>usize i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> len<span class="op">;</span> i<span class="op">++)</span> queue_push<span class="op">(&amp;</span>p<span class="op">-&gt;</span>q<span class="op">,</span> buffer <span class="op">+</span> i<span class="op">);</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> len<span class="op">;</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> pipe_copy<span class="op">(</span>File <span class="op">*</span>self<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    Pipe <span class="op">*</span>p <span class="op">=</span> <span class="op">(</span>Pipe <span class="op">*)</span>self<span class="op">-&gt;</span>bind<span class="op">;</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>self<span class="op">-&gt;</span>read <span class="op">==</span> illegal_rw<span class="op">)</span> p<span class="op">-&gt;</span>wrefcnt<span class="op">++;</span> p<span class="op">-&gt;</span>refcnt<span class="op">++;</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> pipe_close<span class="op">(</span>File <span class="op">*</span>self<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    Pipe <span class="op">*</span>p <span class="op">=</span> <span class="op">(</span>Pipe <span class="op">*)</span>self<span class="op">-&gt;</span>bind<span class="op">;</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>self<span class="op">-&gt;</span>read <span class="op">==</span> illegal_rw<span class="op">)</span> p<span class="op">-&gt;</span>wrefcnt<span class="op">--;</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    self<span class="op">-&gt;</span>occupied <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> p<span class="op">-&gt;</span>refcnt<span class="op">--;</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p<span class="op">-&gt;</span>refcnt <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        queue_free<span class="op">(&amp;</span>p<span class="op">-&gt;</span>q<span class="op">);</span> bd_free<span class="op">(</span>p<span class="op">);</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> make_pipe<span class="op">(</span>usize <span class="op">*</span>p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    Pipe<span class="op">*</span> t <span class="op">=</span> bd_malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span>Pipe<span class="op">));</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    queue_new<span class="op">(&amp;</span>t<span class="op">-&gt;</span>q<span class="op">,</span> <span class="dv">1</span><span class="op">);</span> t<span class="op">-&gt;</span>refcnt <span class="op">=</span> <span class="dv">2</span><span class="op">;</span> t<span class="op">-&gt;</span>wrefcnt <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    File <span class="op">*</span>f <span class="op">=</span> alloc_fd<span class="op">(</span>p<span class="op">);</span> f<span class="op">-&gt;</span>bind <span class="op">=</span> <span class="op">(</span><span class="dt">void</span> <span class="op">*)</span>t<span class="op">;</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    f<span class="op">-&gt;</span>read <span class="op">=</span> pipe_read<span class="op">;</span> f<span class="op">-&gt;</span>write <span class="op">=</span> illegal_rw<span class="op">;</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    f<span class="op">-&gt;</span>copy <span class="op">=</span> pipe_copy<span class="op">;</span> f<span class="op">-&gt;</span>close <span class="op">=</span> pipe_close<span class="op">;</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> alloc_fd<span class="op">(</span>p <span class="op">+</span> <span class="dv">1</span><span class="op">);</span> f<span class="op">-&gt;</span>bind <span class="op">=</span> <span class="op">(</span><span class="dt">void</span> <span class="op">*)</span>t<span class="op">;</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    f<span class="op">-&gt;</span>read <span class="op">=</span> illegal_rw<span class="op">;</span> f<span class="op">-&gt;</span>write <span class="op">=</span> pipe_write<span class="op">;</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    f<span class="op">-&gt;</span>copy <span class="op">=</span> pipe_copy<span class="op">;</span> f<span class="op">-&gt;</span>close <span class="op">=</span> pipe_close<span class="op">;</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> </span></code></pre></div>
<p>我这里Pipe结构体和rCore不太一样，rCore里Pipe对象的意思是“管口”，有额外的PipeRingBuffer对象表示管道本身。我这里Pipe就是管道本身，文件描述符中bind属性指向它，所以文件描述符本身就充当“管口”了。管道中还有一个wrefcnt属性表示写引用计数，在读函数中如果判断写引用计数为0，说明管道中不会再有新数据了，则直接返回已经读取的全部数据。在复制和释放管道文件的时候，判断释放应该修改写引用计数的方法是判断该文件的读函数是否指向<code>illegal_rw</code>，这个函数是一个直接返回错误的函数，用来填充该文件不支持的操作对应函数指针，如果管道文件的读函数指向<code>illegal_rw</code>，说明这个管道文件不支持读取，是写管口，此时就应该修改写引用计数。</p>
</article>
<span class="bg-light text-muted border boder-primary d-block p-2 text-center">
    转载请注明出处<br>
    © 2021 ZimingYuan的博客
</span>
<div style="background-color: #ebd5a1; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; pointer-events: none; opacity: 0.2;">
</div>
</body>
</html>
